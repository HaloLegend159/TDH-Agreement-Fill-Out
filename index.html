<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TDH Agreement – Readable PDF (Fixed)</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{ --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --gap:14px; --radius:14px; }
  *{ box-sizing:border-box }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1100px;margin:20px auto;padding:0 12px 80px}
  .toolbar{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);
    background:color-mix(in oklab,var(--bg) 85%, transparent);
    display:flex;gap:8px;padding:10px 0 14px;align-items:center;flex-wrap:wrap}
  .toolbar h1{margin:0;font-size:18px;margin-right:auto}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button{border:1px solid var(--border);background:#0b1324;color:var(--ink);
    padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
  button.primary{background:#1a2a4b}
  button:hover{background:#101a33}
  .grid{display:grid;gap:var(--gap)}
  .two{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  @media (min-width:980px){ .two{grid-template-columns:repeat(2,minmax(0,1fr))} }
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
  .panel h2{margin:0 0 10px;font-size:16px;font-weight:700}
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  input[type="text"], input[type="tel"], input[type="number"], input[type="date"], textarea, select{
    width:100%; background:#0b1220; color:var(--ink);
    border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none;
    transition:border-color .2s, box-shadow .2s, background .2s
  }
  input::placeholder, textarea::placeholder{ color:#64748b; opacity:.9 }
  input:hover, textarea:hover, select:hover{ border-color:#334155; background:#0d1527 }
  input:focus, textarea:focus, select:focus{ border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25); background:#0a152b }
  input[type="checkbox"], input[type="radio"]{ accent-color:#3b82f6 }
  .checks{display:flex;flex-wrap:wrap;gap:10px 16px}
  .checks label{display:inline-flex;align-items:center;gap:8px;margin:0}
  .sig-row{display:grid;gap:10px;grid-template-columns:1.2fr 1fr 1.2fr;align-items:end}
  .row{display:grid;gap:10px;grid-template-columns:180px 1fr;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1>TDH Agreement (Readable PDF)</h1>
    <div class="actions">
      <button id="loadExample" type="button" title="Fills with fake demo data">Load Example</button>
      <button id="clearForm"   type="button">Clear</button>
      <button id="downloadPdf" type="button" class="primary"><strong>Download PDF</strong></button>
    </div>
  </div>

  <!-- HONEYPOT to discourage browser profile autofill -->
  <form style="position:absolute;left:-9999px;top:-9999px">
    <input type="text" autocomplete="username">
    <input type="password" autocomplete="new-password">
  </form>

  <!-- ===== FORM ===== -->
  <form id="tdhForm" class="grid" autocomplete="off">
    <div class="panel">
      <h2>General Info</h2>
      <div class="grid two">
        <div><label for="name">Name</label><input id="name" name="name" type="text" autocomplete="off" /></div>
        <div><label for="primaryContactName">Primary Contact Name</label><input id="primaryContactName" name="primaryContactName" type="text" autocomplete="off" /></div>
        <div><label for="primaryPhone">Primary Contact Phone Number</label><input id="primaryPhone" name="primaryPhone" type="tel" autocomplete="off" /></div>
        <div><label for="insuranceCompany">Insurance Company</label><input id="insuranceCompany" name="insuranceCompany" type="text" autocomplete="off" /></div>
        <div><label for="claimNumber">Claim Number</label><input id="claimNumber" name="claimNumber" type="text" autocomplete="off" /></div>
        <div><label for="phone">Phone</label><input id="phone" name="phone" type="tel" autocomplete="off" /></div>
        <div><label for="address">Address</label><input id="address" name="address" type="text" autocomplete="off" /></div>
        <div><label for="cityStateZip">City, State, Zip</label><input id="cityStateZip" name="cityStateZip" type="text" autocomplete="off" /></div>
      </div>
    </div>

    <div class="panel">
      <h2>Roofing Info</h2>
      <div class="checks">
        <label><input type="checkbox" name="roofingLocations" value="House">House</label>
        <label><input type="checkbox" name="roofingLocations" value="Garage">Garage</label>
        <label><input type="checkbox" name="roofingLocations" value="Shed">Shed</label>
        <label><input type="checkbox" name="roofingLocations" value="Flat">Flat</label>
      </div>

      <div class="grid two" style="margin-top:10px">
        <div><label for="tearOffLayers">Tear off layers</label><input id="tearOffLayers" name="tearOffLayers" type="number" min="0" step="1" autocomplete="off" /></div>
        <div>
          <label>Underlayment</label>
          <div class="checks">
            <label><input type="radio" name="underlayment" value="15lb">15lb</label>
            <label><input type="radio" name="underlayment" value="30lb">30lb</label>
            <label><input type="radio" name="underlayment" value="Synthetic">Synthetic</label>
          </div>
        </div>

        <div><label for="shinglesBrand">Shingles Brand</label><input id="shinglesBrand" name="shinglesBrand" type="text" autocomplete="off" /></div>
        <div><label for="style">Style</label><input id="style" name="style" type="text" autocomplete="off" /></div>
        <div><label for="color">Color</label><input id="color" name="color" type="text" autocomplete="off" /></div>
        <div><label for="sqs">SQs</label><input id="sqs" name="sqs" type="text" autocomplete="off" /></div>

        <div><label for="iceWater">Ice &amp; Water Barrier (per code)</label><input id="iceWater" name="iceWater" type="text" autocomplete="off" /></div>
        <div><label for="dripEdge">Drip Edge (Color)</label><input id="dripEdge" name="dripEdge" type="text" autocomplete="off" /></div>
        <div><label for="gutterApron">Gutter Apron (Color)</label><input id="gutterApron" name="gutterApron" type="text" autocomplete="off" /></div>

        <div><label for="ventsQty">Vents — Qty</label><input id="ventsQty" name="ventsQty" type="number" min="0" step="1" autocomplete="off" /></div>
        <div>
          <label for="ventsType">Vents — Type</label>
          <select id="ventsType" name="ventsType">
            <option value="">Select…</option>
            <option value="Turtle">Turtle</option>
            <option value="Box">Box/Louver</option>
            <option value="Other">Other (specify)</option>
          </select>
        </div>
        <div><label for="ventsTypeOther">If Other, type</label><input id="ventsTypeOther" name="ventsTypeOther" type="text" autocomplete="off" placeholder="e.g., O’Hagin" /></div>
        <div><label for="ventsColor">Vents — Color</label><input id="ventsColor" name="ventsColor" type="text" autocomplete="off" /></div>

        <div>
          <label>Valleys</label>
          <div class="checks">
            <label><input type="radio" name="valleyMode" value="Open">Open</label>
            <label><input type="radio" name="valleyMode" value="Closed">Closed</label>
          </div>
        </div>
        <div><label for="valleysColor">Valleys — Color</label><input id="valleysColor" name="valleysColor" type="text" autocomplete="off" placeholder="e.g., Painted" /></div>

        <div><label for="pipeJacksQty">Pipe Jacks — Qty</label><input id="pipeJacksQty" name="pipeJacksQty" type="number" min="0" step="1" autocomplete="off" /></div>
        <div><label for="pipeJacksType">Pipe Jacks — Type</label><input id="pipeJacksType" name="pipeJacksType" type="text" autocomplete="off" placeholder="e.g., NC" /></div>

        <div><label for="roofPitch">Roof Pitch</label><input id="roofPitch" name="roofPitch" type="text" autocomplete="off" placeholder="e.g., 4/12" /></div>
        <div><label for="stories">Stories</label><input id="stories" name="stories" type="number" min="0" step="1" autocomplete="off" /></div>
        <div><label for="roofSize">Size</label><input id="roofSize" name="roofSize" type="text" autocomplete="off" placeholder="e.g., 1,050 SF" /></div>

        <div>
          <label>Roof Type</label>
          <div class="checks">
            <label><input type="checkbox" name="roofType" value="Hip">Hip</label>
            <label><input type="checkbox" name="roofType" value="Gable">Gable</label>
            <label><input type="checkbox" name="roofType" value="Both">Both</label>
          </div>
        </div>

        <div><label for="ridgeCap">Ridge Cap</label><input id="ridgeCap" name="ridgeCap" type="text" autocomplete="off" /></div>
        <div><label for="ridgeVent">Ridge Vent</label><input id="ridgeVent" name="ridgeVent" type="text" autocomplete="off" /></div>

        <div><label for="sideWallQty">Side Wall Flashing — Qty (LF)</label><input id="sideWallQty" name="sideWallQty" type="number" min="0" step="1" autocomplete="off" /></div>
        <div><label for="sideWallColor">Side Wall Flashing — Color</label><input id="sideWallColor" name="sideWallColor" type="text" autocomplete="off" /></div>
        <div>
          <label>Side Wall Flashing — Material</label>
          <div class="checks">
            <label><input type="radio" name="sideWallMaterial" value="Metal">Metal</label>
            <label><input type="radio" name="sideWallMaterial" value="Plastic">Plastic</label>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Gutters</h2>
      <div class="grid two">
        <div>
          <label>Gutters:</label>
          <div class="checks">
            <label><input type="radio" name="guttersSize" value="5">5"</label>
            <label><input type="radio" name="guttersSize" value="6">6"</label>
          </div>
        </div>
        <div><label for="guttersColor">Gutters Color</label><input id="guttersColor" name="guttersColor" type="text" autocomplete="off" /></div>
        <div>
          <label>Downspouts:</label>
          <div class="checks">
            <label><input type="radio" name="downspoutsSize" value="2x3">2×3</label>
            <label><input type="radio" name="downspoutsSize" value="3x4">3×4</label>
          </div>
        </div>
        <div><label for="downspoutsColor">Downspouts Color</label><input id="downspoutsColor" name="downspoutsColor" type="text" autocomplete="off" /></div>
        <div>
          <label>Gutter Guards:</label>
          <div class="checks">
            <label><input type="checkbox" name="gutterGuards" value="Plastic">Plastic</label>
            <label><input type="checkbox" name="gutterGuards" value="RX">RX</label>
            <label><input type="checkbox" name="gutterGuards" value="Leaf Free">Leaf Free</label>
          </div>
        </div>
        <div><label for="gutterNotes">Gutter Notes</label><input id="gutterNotes" name="gutterNotes" type="text" autocomplete="off" /></div>
      </div>
    </div>

    <div class="panel">
      <h2>Siding Info</h2>
      <div class="grid two">
        <div><label for="sidingBrand">Brand</label><input id="sidingBrand" name="sidingBrand" type="text" autocomplete="off" /></div>
        <div><label for="sidingStyle">Style</label><input id="sidingStyle" name="sidingStyle" type="text" autocomplete="off" /></div>
        <div><label for="sidingSqs">SQs</label><input id="sidingSqs" name="sidingSqs" type="text" autocomplete="off" /></div>
        <div><label for="sidingColor">Color</label><input id="sidingColor" name="sidingColor" type="text" autocomplete="off" /></div>
        <div>
          <label>Elevations</label>
          <div class="checks">
            <label><input type="checkbox" name="elevations" value="Front">Front</label>
            <label><input type="checkbox" name="elevations" value="Right">Right</label>
            <label><input type="checkbox" name="elevations" value="Left">Left</label>
            <label><input type="checkbox" name="elevations" value="Rear">Rear</label>
          </div>
        </div>
        <div><label for="trim">Trim</label><input id="trim" name="trim" type="text" autocomplete="off" /></div>
        <div>
          <label>Fascia</label>
          <div class="checks">
            <label><input type="radio" name="fascia" value="Smooth">Smooth</label>
            <label><input type="radio" name="fascia" value="PVC">PVC</label>
          </div>
        </div>
        <div><label for="fasciaColor">Fascia Color</label><input id="fasciaColor" name="fasciaColor" type="text" autocomplete="off" /></div>
        <div>
          <label>Soffit</label>
          <div class="checks">
            <label><input type="radio" name="soffit" value="Solid">Solid</label>
            <label><input type="radio" name="soffit" value="Vented">Vented</label>
          </div>
        </div>
        <div><label for="soffitColor">Soffit Color</label><input id="soffitColor" name="soffitColor" type="text" autocomplete="off" /></div>
        <div>
          <label>Window Wraps</label>
          <div class="checks">
            <label><input type="radio" name="windowWraps" value="Smooth">Smooth</label>
            <label><input type="radio" name="windowWraps" value="PVC">PVC</label>
          </div>
        </div>
        <div><label for="windowWrapsColor">Window Wraps Color</label><input id="windowWrapsColor" name="windowWrapsColor" type="text" autocomplete="off" /></div>
        <div>
          <label>Blocks</label>
          <div class="checks">
            <label><input type="checkbox" name="blocks" value="Light Blocks">Light Blocks</label>
            <label><input type="checkbox" name="blocks" value="Split Blocks">Split Blocks</label>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>More, Payment & Instructions</h2>
      <div class="grid two">
        <div><label for="materialDrop">Material drop off</label><input id="materialDrop" name="materialDrop" type="text" autocomplete="off" /></div>
        <div><label for="redeck">Redeck (Partial or Full)</label><input id="redeck" name="redeck" type="text" autocomplete="off" /></div>
        <div><label for="interiorDamage">Interior damage</label><input id="interiorDamage" name="interiorDamage" type="text" autocomplete="off" /></div>
        <div><label for="cleanup">Cleanup</label><input id="cleanup" name="cleanup" type="text" autocomplete="off" /></div>
        <div style="grid-column:1/-1"><label for="miscNotes">Misc. Notes</label><textarea id="miscNotes" name="miscNotes" autocomplete="off" placeholder="Optional"></textarea></div>

        <div><label for="agreedAmount">Agreed Amount ($)</label><input id="agreedAmount" name="agreedAmount" type="text" autocomplete="off" /></div>
        <div><label for="firstPayment">First Payment ($)</label><input id="firstPayment" name="firstPayment" type="text" autocomplete="off" /></div>
        <div><label for="finalPayment">Final Payment ($)</label><input id="finalPayment" name="finalPayment" type="text" autocomplete="off" /></div>

        <div style="grid-column:1/-1" class="row">
          <label for="instructions">Instructions / Location</label>
          <input id="instructions" name="instructions" type="text" autocomplete="off" placeholder="Address / access notes" />
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Signatures</h2>
      <div class="sig-row">
        <div><label for="custDate">Agreed to by Customer on date</label><input id="custDate" name="custDate" type="date" autocomplete="off" /></div>
        <div><label for="custSignature">Customer Signature (typed)</label><input id="custSignature" name="custSignature" type="text" autocomplete="off" placeholder="Sign here" /></div>
        <div><label for="tdhDate">Agreed to by TDH Representative on date</label><input id="tdhDate" name="tdhDate" type="date" autocomplete="off" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <label for="tdhSignature">TDH Representative Signature (typed)</label>
        <input id="tdhSignature" name="tdhSignature" type="text" autocomplete="off" placeholder="Sign here" />
      </div>
    </div>
  </form>
</div>

<!-- jsPDF loader -->
<script>
async function ensureJsPDFLoaded(){
  if (window.jspdf && window.jspdf.jsPDF) return true;
  const urls = [
    "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
    "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
  ];
  for (const u of urls){
    try{
      await new Promise((res,rej)=>{const s=document.createElement('script');s.src=u;s.onload=res;s.onerror=rej;document.head.appendChild(s);});
      if(window.jspdf?.jsPDF) return true;
    }catch(e){}
  }
  alert("Couldn't load jsPDF."); return false;
}
</script>

<script>
function formToObject(form){
  const data={};
  new FormData(form).forEach((v,k)=>{
    if (data[k]!==undefined){ if(!Array.isArray(data[k])) data[k]=[data[k]]; data[k].push(v); }
    else data[k]=v;
  });
  return data;
}
function fillForm(form,obj){
  for(const el of form.elements){
    if(!el.name) continue;
    const v=obj[el.name]; if(v===undefined) continue;
    if(el.type==='checkbox') el.checked = Array.isArray(v) ? v.includes(el.value) : (v===el.value||v===true);
    else if(el.type==='radio') el.checked = (String(v)===el.value);
    else el.value = Array.isArray(v) ? v[0] : v;
  }
}
</script>

<script>
function computeValues(d){
  const out = {};
  const num = n => (n===undefined || n===null || n==='') ? '' : String(n);

  Object.assign(out, {
    name:d.name||'', primaryContactName:d.primaryContactName||'', primaryPhone:d.primaryPhone||'',
    insuranceCompany:d.insuranceCompany||'', claimNumber:d.claimNumber||'', phone:d.phone||'',
    address:d.address||'', cityStateZip:d.cityStateZip||'',

    tearOffLayers:d.tearOffLayers||'',
    shinglesBrand:d.shinglesBrand||'', style:d.style||'', color:d.color||'', sqs:d.sqs||'',
    iceWater:d.iceWater||'', dripEdge:d.dripEdge||'', gutterApron:d.gutterApron||'',
    roofPitch:d.roofPitch||'', stories:d.stories||'', roofSize:d.roofSize||'',
    ridgeCap:d.ridgeCap||'', ridgeVent:d.ridgeVent||'',

    guttersColor:d.guttersColor||'', downspoutsColor:d.downspoutsColor||'', gutterNotes:d.gutterNotes||'',

    sidingBrand:d.sidingBrand||'', sidingStyle:d.sidingStyle||'', sidingSqs:d.sidingSqs||'', sidingColor:d.sidingColor||'',
    trim:d.trim||'', fasciaColor:d.fasciaColor||'', soffitColor:d.soffitColor||'',
    windowWrapsColor:d.windowWrapsColor||'',

    materialDrop:d.materialDrop||'', redeck:d.redeck||'', interiorDamage:d.interiorDamage||'',
    cleanup:d.cleanup||'', miscNotes:d.miscNotes||'',
    agreedAmount:d.agreedAmount||'', firstPayment:d.firstPayment||'', finalPayment:d.finalPayment||'',
    custDate:d.custDate||'', custSignature:d.custSignature||'', tdhDate:d.tdhDate||'', tdhSignature:d.tdhSignature||'',
    instructions:d.instructions||'',
  });

  const ventTypeRaw = (d.ventsType==='Other' ? d.ventsTypeOther : d.ventsType) || '';
  const ventType = ventTypeRaw.trim();
  out.ventsQty = num(d.ventsQty);
  out.ventsType = ventType;
  out.ventsColor = (d.ventsColor||'').trim();
  out.x_vents_Turtle = /\bturtle\b/i.test(ventType) ? 'X' : '';

  const vm = d.valleyMode || '';
  out.x_valley_Open   = vm==='Open'   ? 'X' : '';
  out.x_valley_Closed = vm==='Closed' ? 'X' : '';
  out.valleysColor = (d.valleysColor||'').trim();

  out.pipeJacksQty = num(d.pipeJacksQty);
  out.pipeJacksType = (d.pipeJacksType||'').trim();

  const swQty = num(d.sideWallQty);
  const swColor = (d.sideWallColor||'').trim();
  out.sideWallMain = [swQty && (swQty + ' LF'), swColor].filter(Boolean).join(' ');
  out.x_sideWall_Metal   = d.sideWallMaterial==='Metal'   ? 'X' : '';
  out.x_sideWall_Plastic = d.sideWallMaterial==='Plastic' ? 'X' : '';

  const loc = new Set([].concat(d.roofingLocations||[]));
  out.x_loc_House  = loc.has('House')  ? 'X' : '';
  out.x_loc_Garage = loc.has('Garage') ? 'X' : '';
  out.x_loc_Shed   = loc.has('Shed')   ? 'X' : '';
  out.x_loc_Flat   = loc.has('Flat')   ? 'X' : '';

  out.x_under_15   = d.underlayment==='15lb'      ? 'X' : '';
  out.x_under_30   = d.underlayment==='30lb'      ? 'X' : '';
  out.x_under_Syn  = d.underlayment==='Synthetic' ? 'X' : '';

  const rt = new Set([].concat(d.roofType||[]));
  out.x_rt_Hip   = rt.has('Hip')   ? 'X' : '';
  out.x_rt_Gable = rt.has('Gable') ? 'X' : '';
  out.x_rt_Both  = rt.has('Both')  ? 'X' : '';

  out.x_gut_5  = d.guttersSize==='5' ? 'X' : '';
  out.x_gut_6  = d.guttersSize==='6' ? 'X' : '';
  out.x_ds_23  = d.downspoutsSize==='2x3' ? 'X' : '';
  out.x_ds_34  = d.downspoutsSize==='3x4' ? 'X' : '';

  const gg = new Set([].concat(d.gutterGuards||[]));
  out.x_guard_Plastic  = gg.has('Plastic')   ? 'X' : '';
  out.x_guard_RX       = gg.has('RX')        ? 'X' : '';
  out.x_guard_LeafFree = gg.has('Leaf Free') ? 'X' : '';

  out.x_fas_Smooth = d.fascia==='Smooth' ? 'X' : '';
  out.x_fas_PVC    = d.fascia==='PVC'    ? 'X' : '';
  out.x_sof_Solid  = d.soffit==='Solid'  ? 'X' : '';
  out.x_sof_Vented = d.soffit==='Vented' ? 'X' : '';
  out.x_wrap_Smooth= d.windowWraps==='Smooth' ? 'X' : '';
  out.x_wrap_PVC   = d.windowWraps==='PVC'    ? 'X' : '';

  out._elev = new Set([].concat(d.elevations||[]));
  out._blocks = new Set([].concat(d.blocks||[]));
  return out;
}
</script>

<script>
/* >>> READABLE, HIGH-CONTRAST PDF (fixed + no-overlap) <<< */
document.getElementById('downloadPdf').addEventListener('click', async ()=>{
  if (!(await ensureJsPDFLoaded())) return;
  const { jsPDF } = window.jspdf;

  // Disable compression + only-used-fonts to avoid glyph scrambling
  const doc = new jsPDF({ unit:'in', format:'letter', compress:false, putOnlyUsedFonts:false, precision:12 });
  const W = 8.5, H = 11, M = 0.5;
  const LCOL_W = 5.0, GAP = 0.22;

  // Stable core font
  const FS = { TITLE:22, SUB:11, SECTION:13.5, LABEL:10.5, VALUE:11.5, SMALL:9 };
  const set = (w='normal', size=FS.VALUE)=>{
    doc.setFont('times', w === 'bold' ? 'bold' : 'normal');
    doc.setFontSize(size);
    doc.setTextColor(0,0,0);
  };

  // Helpers
  const line = (x1,y1,x2,y2,w=0.022)=>{ doc.setDrawColor(30,30,30); doc.setLineWidth(w); doc.line(x1,y1,x2,y2); };
  const hline = (x,y,wid,w=0.018)=> line(x,y,x+wid,y,w);
  const vline = (x,y,hei,w=0.018)=> line(x,y,x,y+hei,w);
  const rect  = (x,y,w,h, lw=0.018)=>{ doc.setDrawColor(40,40,40); doc.setLineWidth(lw); doc.rect(x,y,w,h); };
  const sectionBar = (title, x, y, w)=>{ doc.setFillColor(235); doc.roundedRect(x,y,w,0.35,0.06,0.06,'F'); set('bold',FS.SECTION); doc.text(title, x+0.14, y+0.26); };

  // Fit value within available width (in inches) with ellipsis
  function valueFit(x,y,text,maxW,weight='normal',size=FS.VALUE){
    if(!text) return;
    set(weight,size);
    let t = String(text);
    while (doc.getTextWidth(t) > maxW && t.length > 0){
      t = t.slice(0,-1);
    }
    if (String(text).length > t.length) {
      if (t.length > 1) t = t.slice(0,-1) + '…';
      else t = '…';
    }
    doc.text(t, x, y);
  }

  const v = computeValues(formToObject(document.getElementById('tdhForm')));

  // Header
  set('bold',FS.TITLE);
  doc.text('TDH Agreement', W/2, M+0.35, {align:'center'});
  set('normal',FS.SUB);
  doc.text('2513 River Rd Dr, Waterloo, NE 68069', W/2, M+0.65, {align:'center'});

  // General Info box
  const gi = {x:M, y:M+0.95, w:W-2*M, h:1.85};
  rect(gi.x,gi.y,gi.w,gi.h,0.02);
  vline(gi.x+gi.w/2, gi.y, gi.h, 0.016);
  const rH = gi.h/4;
  [1,2,3].forEach(i=>hline(gi.x, gi.y+i*rH, gi.w, 0.016));

  // GI labels
  set('bold',FS.LABEL);
  doc.text('Name:', gi.x+0.12, gi.y+0.3);
  doc.text('Primary Contact Name:', gi.x+gi.w/2+0.12, gi.y+0.3);
  doc.text('Address:', gi.x+0.12, gi.y+rH+0.3);
  doc.text('Primary Contact Phone Number:', gi.x+gi.w/2+0.12, gi.y+rH+0.3);
  doc.text('City, State, Zip:', gi.x+0.12, gi.y+2*rH+0.3);
  doc.text('Insurance Company:', gi.x+gi.w/2+0.12, gi.y+2*rH+0.3);
  doc.text('Phone:', gi.x+0.12, gi.y+3*rH+0.3);
  doc.text('Claim Number:', gi.x+gi.w/2+0.12, gi.y+3*rH+0.3);

  // GI values (fit them into columns)
  valueFit(gi.x+0.95, gi.y+0.3, v.name,                gi.w/2 - 1.10);
  valueFit(gi.x+gi.w/2+1.75, gi.y+0.3, v.primaryContactName, gi.w/2 - 1.95);
  valueFit(gi.x+0.85, gi.y+rH+0.3, v.address,          gi.w/2 - 1.00);
  valueFit(gi.x+gi.w/2+2.55, gi.y+rH+0.3, v.primaryPhone,      gi.w/2 - 2.70);
  valueFit(gi.x+1.25, gi.y+2*rH+0.3, v.cityStateZip,   gi.w/2 - 1.40);
  valueFit(gi.x+gi.w/2+1.9, gi.y+2*rH+0.3, v.insuranceCompany, gi.w/2 - 2.05);
  valueFit(gi.x+0.8, gi.y+3*rH+0.3, v.phone,           gi.w/2 - 0.95);
  valueFit(gi.x+gi.w/2+1.5, gi.y+3*rH+0.3, v.claimNumber,      gi.w/2 - 1.65);

  // Columns start
  const L = {x:M, y:gi.y+gi.h+0.4, w:LCOL_W};
  const R = {x:M+LCOL_W+GAP, y:L.y, w:W-2*M-LCOL_W-GAP};

  /* LEFT COLUMN */
  sectionBar('Roofing Info', L.x, L.y, L.w);
  let y = L.y+0.45;

  set('bold',FS.LABEL); doc.text('Roofing location/s:', L.x, y);
  const chk = (x,y,flag,label)=>{ const s=0.22; doc.setDrawColor(60); doc.setLineWidth(0.014); doc.rect(x,y-s+0.06,s,s); if(flag){ set('bold',12.5); doc.text('X', x+0.03, y-0.01);} set('normal',FS.VALUE); doc.text(label, x+0.3, y+0.06); set('bold',FS.LABEL); };
  chk(L.x+1.55, y, !!v.x_loc_House,  'House');
  chk(L.x+2.70, y, !!v.x_loc_Garage, 'Garage');
  chk(L.x+3.85, y, !!v.x_loc_Shed,   'Shed');
  chk(L.x+4.85, y, !!v.x_loc_Flat,   'Flat');
  y+=0.36;

  doc.text('Roof Type:', L.x, y);
  chk(L.x+0.85,y, !!v.x_rt_Hip,   'Hip');
  chk(L.x+1.75,y, !!v.x_rt_Gable, 'Gable');
  chk(L.x+2.75,y, !!v.x_rt_Both,  'Both');
  set('bold',FS.LABEL); doc.text('Roof Pitch:', L.x+3.9, y); hline(L.x+4.7,y,0.9);
  valueFit(L.x+4.78,y, v.roofPitch, 0.86);
  doc.text('Stories:', L.x+5.75, y); hline(L.x+6.35,y,0.55);
  valueFit(L.x+6.42,y, v.stories, 0.49);
  y+=0.36;

  doc.text('Tear off layers:', L.x, y); hline(L.x+1.45,y,0.7);
  valueFit(L.x+1.52,y, v.tearOffLayers, 0.64);
  y+=0.34;

  doc.text('Underlayment:', L.x, y);
  chk(L.x+1.15,y, !!v.x_under_15, '15lb');
  chk(L.x+2.10,y, !!v.x_under_30, '30lb');
  chk(L.x+3.05,y, !!v.x_under_Syn,'Synthetic');
  y+=0.34;

  doc.text('Ice and water Barrier (per code):', L.x, y); hline(L.x+3.15,y,2.0);
  valueFit(L.x+3.22,y, v.iceWater, 1.92);
  y+=0.34;

  doc.text('Shingles Brand:', L.x, y); hline(L.x+1.45,y,1.2);
  valueFit(L.x+1.52,y, v.shinglesBrand, 1.12);
  doc.text('Style:', L.x+2.9, y); hline(L.x+3.35,y,1.0);
  valueFit(L.x+3.42,y, v.style, 0.92);
  doc.text('Color:', L.x+4.45,y); hline(L.x+4.9,y,1.0);
  valueFit(L.x+4.97,y, v.color, 0.92);
  doc.text('SQs:', L.x+6.0,y); hline(L.x+6.35,y,0.6);
  valueFit(L.x+6.42,y, v.sqs, 0.54);
  y+=0.34;

  doc.text('Drip Edge:', L.x, y); hline(L.x+0.95,y,1.2);
  valueFit(L.x+1.02,y, v.dripEdge, 1.12);
  doc.text('Gutter Apron:', L.x+2.45, y); hline(L.x+3.5,y,1.3);
  valueFit(L.x+3.57,y, v.gutterApron, 1.22);
  y+=0.34;

  chk(L.x, y, !!v.x_vents_Turtle, '');
  set('bold',FS.LABEL); doc.text('Vents:', L.x+0.28, y);
  hline(L.x+0.95,y,2.0);
  valueFit(L.x+1.02,y, [v.ventsQty, v.ventsType].filter(Boolean).join(' '), 1.92);
  doc.text('Color:', L.x+3.1,y); hline(L.x+3.55,y,1.1);
  valueFit(L.x+3.62,y, v.ventsColor, 1.02);
  y+=0.34;

  doc.text('Valleys:', L.x, y);
  doc.text('Color:', L.x+0.7,y); hline(L.x+1.1,y,1.2);
  valueFit(L.x+1.17,y, v.valleysColor, 1.12);
  doc.text('Open or Closed', L.x+2.55,y);
  chk(L.x+3.9,y, !!v.x_valley_Open,  'Open');
  chk(L.x+5.1,y, !!v.x_valley_Closed,'Closed');
  y+=0.34;

  doc.text('Pipe Jacks QTY:', L.x, y); hline(L.x+1.5,y,0.8);
  valueFit(L.x+1.57,y, v.pipeJacksQty, 0.74);
  doc.text('Type:', L.x+2.5,y); hline(L.x+2.9,y,1.0);
  valueFit(L.x+2.97,y, v.pipeJacksType, 0.92);
  doc.text('Size:', L.x+4.1,y); hline(L.x+4.45,y,1.15);
  valueFit(L.x+4.52,y, v.roofSize, 1.07);
  y+=0.34;

  doc.text('Ridge Cap:', L.x, y); hline(L.x+1.0,y,1.4);
  valueFit(L.x+1.07,y, v.ridgeCap, 1.32);
  doc.text('Ridge Vent:', L.x+2.6,y); hline(L.x+3.45,y,1.7);
  valueFit(L.x+3.52,y, v.ridgeVent, 1.62);

  // Gutters / Downspouts
  const gY = L.y + 4.7;
  sectionBar('Gutters & Downspouts', L.x, gY, L.w);
  let gy = gY+0.45;

  doc.text('Gutters:', L.x, gy);
  chk(L.x+0.9,gy, !!v.x_gut_5, '5"');
  chk(L.x+1.8,gy, !!v.x_gut_6, '6"');
  doc.text('Color:', L.x+2.6,gy); hline(L.x+3.05,gy,1.2);
  valueFit(L.x+3.12,gy, v.guttersColor, 1.12);
  doc.text('Downspouts:', L.x+4.5,gy);
  chk(L.x+5.6,gy, !!v.x_ds_23, '2×3');
  chk(L.x+6.6,gy, !!v.x_ds_34, '3×4');
  doc.text('Color:', L.x+7.45,gy); hline(L.x+7.9,gy,0.9);
  valueFit(L.x+7.97,gy, v.downspoutsColor, 0.82);
  gy+=0.36;

  doc.text('Gutter Guards:', L.x, gy);
  chk(L.x+1.3,gy, !!v.x_guard_Plastic, 'Plastic');
  chk(L.x+2.4,gy, !!v.x_guard_RX, 'RX');
  chk(L.x+3.2,gy, !!v.x_guard_LeafFree, 'Leaf Free');
  doc.text('Notes:', L.x+4.4,gy); hline(L.x+4.85,gy,3.1);
  valueFit(L.x+4.92,gy, v.gutterNotes, 3.02);

  // Siding
  const sY = gY + 1.25;
  sectionBar('Siding Info', L.x, sY, L.w);
  let sy = sY+0.45;

  doc.text('Brand:', L.x,sy); hline(L.x+0.6,sy,1.2);
  valueFit(L.x+0.67,sy, v.sidingBrand, 1.12);
  doc.text('Style:', L.x+2.0,sy); hline(L.x+2.45,sy,1.5);
  valueFit(L.x+2.52,sy, v.sidingStyle, 1.42);
  doc.text('SQs:', L.x+4.1,sy); hline(L.x+4.45,sy,0.8);
  valueFit(L.x+4.52,sy, v.sidingSqs, 0.72);
  doc.text('Color:', L.x+5.35,sy); hline(L.x+5.8,sy,1.2);
  valueFit(L.x+5.87,sy, v.sidingColor, 1.12);
  sy+=0.36;

  doc.text('Elevations:', L.x,sy);
  chk(L.x+0.95,sy, v._elev.has('Front'), 'Front');
  chk(L.x+2.0, sy, v._elev.has('Right'), 'Right');
  chk(L.x+3.0, sy, v._elev.has('Left'),  'Left');
  chk(L.x+4.0, sy, v._elev.has('Rear'),  'Rear');
  doc.text('Trim:', L.x+5.2,sy); hline(L.x+5.6,sy,1.6);
  valueFit(L.x+5.67,sy, v.trim, 1.52);
  sy+=0.36;

  doc.text('Fascia:', L.x,sy);
  chk(L.x+0.7,sy, !!v.x_fas_Smooth, 'Smooth');
  chk(L.x+2.0,sy, !!v.x_fas_PVC,    'PVC');
  doc.text('Color:', L.x+3.1,sy); hline(L.x+3.55,sy,1.3);
  valueFit(L.x+3.62,sy, v.fasciaColor, 1.22);

  doc.text('Soffit:', L.x+5.1,sy);
  chk(L.x+5.7,sy, !!v.x_sof_Solid,  'Solid');
  chk(L.x+6.8,sy, !!v.x_sof_Vented, 'Vented');
  doc.text('Color:', L.x+7.9,sy); hline(L.x+8.3,sy,0.6);
  valueFit(L.x+8.37,sy, v.soffitColor, 0.52);
  sy+=0.36;

  doc.text('Window Wraps:', L.x,sy);
  chk(L.x+1.25,sy, !!v.x_wrap_Smooth, 'Smooth');
  chk(L.x+2.6, sy,  !!v.x_wrap_PVC,   'PVC');
  doc.text('Color:', L.x+3.7, sy); hline(L.x+4.15,sy,1.45);
  valueFit(L.x+4.22,sy, v.windowWrapsColor, 1.37);
  doc.text('Blocks:', L.x+5.95,sy);
  chk(L.x+6.55,sy, v._blocks.has('Light Blocks'), 'Light Blocks');
  chk(L.x+7.95,sy, v._blocks.has('Split Blocks'), 'Split Blocks');

  /* RIGHT COLUMN */
  sectionBar('More Info', R.x, R.y, R.w);
  let ry = R.y+0.45;

  set('bold',FS.LABEL); doc.text('Redeck (Partial or Full):', R.x, ry); hline(R.x+2.25,ry, R.w-2.45);
  valueFit(R.x+2.32,ry, (v.redeck||''), R.w-2.55);
  ry+=0.36;

  doc.text('Interior damage:', R.x, ry); hline(R.x+1.55,ry, R.w-1.75);
  valueFit(R.x+1.62,ry, (v.interiorDamage||''), R.w-1.85);
  ry+=0.36;

  doc.text('Cleanup:', R.x, ry); hline(R.x+0.9,ry, R.w-1.1);
  valueFit(R.x+0.97,ry, (v.cleanup||''), R.w-1.2);
  ry+=0.46;

  doc.text('Material drop off:', R.x, ry); hline(R.x+1.7,ry, R.w-1.9);
  valueFit(R.x+1.77,ry, v.materialDrop, R.w-2.0);
  ry+=0.55;

  sectionBar('Payment Info', R.x, ry, R.w); ry+=0.45;
  doc.text('Agreed Amount:', R.x, ry); hline(R.x+1.4,ry, R.w-1.6);
  valueFit(R.x+1.47,ry, v.agreedAmount, R.w-1.7); ry+=0.36;
  doc.text('First Payment:', R.x, ry); hline(R.x+1.35,ry, R.w-1.55);
  valueFit(R.x+1.42,ry, v.firstPayment, R.w-1.65); ry+=0.36;
  doc.text('Final Payment:', R.x, ry); hline(R.x+1.35,ry, R.w-1.55);
  valueFit(R.x+1.42,ry, v.finalPayment, R.w-1.65); ry+=0.66;

  sectionBar('Instructions', R.x, ry, R.w); ry+=0.45;
  // 3 ruled lines + wrapped text (clamped to 3 lines)
  doc.setDrawColor(170);
  hline(R.x, ry, R.w, 0.012); hline(R.x, ry+0.38, R.w, 0.012); hline(R.x, ry+0.76, R.w, 0.012);
  doc.setDrawColor(30);
  if (v.instructions){
    set('normal',FS.VALUE);
    const lines = doc.splitTextToSize(v.instructions, R.w-0.12).slice(0,3);
    lines.forEach((ln,i)=> doc.text(ln, R.x+0.06, ry + i*0.38 - 0.02));
  }

  // Signatures
  const sigY = H - 1.05;
  set('bold',FS.LABEL); doc.text('Agreed to by Customer on date:', M, sigY); hline(M+2.2, sigY, 1.25);
  valueFit(M+2.28, sigY, v.custDate, 1.17);
  doc.text('Signature:', M+3.6, sigY); hline(M+4.25, sigY, 2.3);
  valueFit(M+4.32, sigY, v.custSignature, 2.22);

  const sigY2 = sigY + 0.45;
  doc.text('Agreed to by TDH Representative on date:', M, sigY2); hline(M+3.5, sigY2, 1.25);
  valueFit(M+3.58, sigY2, v.tdhDate, 1.17);
  doc.text('Signature:', M+4.95, sigY2); hline(M+5.6, sigY2, 2.05);
  valueFit(M+5.67, sigY2, v.tdhSignature, 1.97);

  // Save
  const filename = `TDH_Agreement_${(v.name||'Filled').replace(/\s+/g,'_')}.pdf`;
  doc.save(filename);
});
</script>

<script>
/* DEMO—fake example + clear */
const form = document.getElementById('tdhForm');
const example = {
  name:"Jordan Sample", address:"7425 Oak Meadow Ct", cityStateZip:"Prairie City, NE 68000",
  primaryContactName:"Taylor North", primaryPhone:"(555) 010-7744",
  insuranceCompany:"Prairie Mutual", claimNumber:"PRM-2045-XS9",
  phone:"(555) 010-2299",
  roofingLocations:["House","Garage","Shed","Flat"],
  tearOffLayers:"1", underlayment:"Synthetic",
  shinglesBrand:"CertainTeed", style:"Landmark", color:"Desert Sand", sqs:"28",
  iceWater:"Per code", dripEdge:"White", gutterApron:"White",
  ventsQty:"9", ventsType:"Turtle", ventsTypeOther:"", ventsColor:"White",
  valleyMode:"Open", valleysColor:"Painted",
  pipeJacksQty:"2", pipeJacksType:"NC",
  roofPitch:"4/12", stories:"1", roofSize:"1,050 SF",
  roofType:["Hip","Gable","Both"],
  ridgeCap:"High Profile", ridgeVent:"Shingle-over",
  sideWallQty:"82", sideWallColor:"White", sideWallMaterial:"Metal",
  guttersSize:"6", guttersColor:"White",
  downspoutsSize:"3x4", downspoutsColor:"Bronze",
  gutterGuards:["Plastic","RX","Leaf Free"],
  gutterNotes:"Leafguard brand; 121 LF White",
  materialDrop:"Driveway", redeck:"Partial near eaves",
  interiorDamage:"Living room ceiling stain",
  cleanup:"Magnetic roller; full debris haul",
  miscNotes:"Reset satellite; R&R 1 EA 6\" rain cap",
  agreedAmount:"ACV", firstPayment:"RCV + Approved Supplements", finalPayment:"RCV + Approved Supplements",
  sidingBrand:"Norandex", sidingStyle:"Board & Batten", sidingSqs:"18", sidingColor:"Clay",
  elevations:["Front","Right","Left","Rear"], trim:"3.5\" PVC",
  fascia:"PVC", fasciaColor:"White", soffit:"Vented", soffitColor:"White",
  windowWraps:"PVC", windowWrapsColor:"White",
  blocks:["Light Blocks","Split Blocks"],
  custDate:"", custSignature:"", tdhDate:"", tdhSignature:"",
  instructions:"2513 River Rd Dr, Waterloo, NE 68069"
};
document.getElementById('loadExample').addEventListener('click', ()=> fillForm(form, example));
document.getElementById('clearForm').addEventListener('click', ()=> form.reset());
</script>
</body>
</html>
