<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TDH Agreement – Exact PDF (Mobile Friendly)</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --gap:14px; --radius:14px; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1100px;margin:20px auto;padding:0 12px 80px}
  .toolbar{
    position:sticky;top:0;z-index:20;backdrop-filter:blur(6px);
    background:color-mix(in oklab,var(--bg) 85%, transparent);
    display:flex;gap:8px;padding:10px 0 14px;align-items:center;flex-wrap:wrap
  }
  .toolbar h1{margin:0;font-size:18px;margin-right:auto}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button{
    border:1px solid var(--border);background:#0b1324;color:var(--ink);
    padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600
  }
  button.primary{background:#1a2a4b}
  button:hover{background:#101a33}
  .grid{display:grid;gap:var(--gap)}
  .two{grid-template-columns:1fr 1fr}
  .panel{
    background:var(--panel);border:1px solid var(--border);
    border-radius:var(--radius);padding:16px
  }
  .panel h2{margin:0 0 10px;font-size:16px;font-weight:700}
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}

  /* Pretty inputs (no white boxes) */
  input[type="text"], input[type="tel"], input[type="number"], input[type="date"], textarea, select{
    width:100%; background:#0b1220; color:var(--ink);
    border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none;
    appearance:none; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    transition:border-color .2s, box-shadow .2s, background .2s
  }
  input::placeholder, textarea::placeholder{ color:#64748b; opacity:.9 }
  input:hover, textarea:hover, select:hover{ border-color:#334155; background:#0d1527 }
  input:focus, textarea:focus, select:focus{ border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25); background:#0a152b }
  input[type="checkbox"], input[type="radio"]{ accent-color:#3b82f6 }

  .checks{display:flex;flex-wrap:wrap;gap:10px 16px}
  .checks label{display:inline-flex;align-items:center;gap:8px;margin:0}
  .sig-row{display:grid;gap:10px;grid-template-columns:1.2fr 1fr 1.2fr;align-items:end}
  .row{display:grid;gap:10px;grid-template-columns:160px 1fr;align-items:center}

  .logo-box{display:flex;align-items:center;gap:8px}
  .logo-box img{height:28px;width:auto;object-fit:contain}
</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="logo-box">
        <img src="assets/tdh-logo.png" alt="" onerror="this.style.display='none'">
        <h1>TDH Agreement (Editable)</h1>
      </div>
      <div class="actions">
        <button type="button" id="loadExample">Load Example</button>
        <button type="button" id="clearForm">Clear</button>
        <button type="button" id="saveJson">Save as JSON</button>
        <button type="button" class="primary" id="downloadPdf"><strong>Download PDF</strong></button>
      </div>
    </div>

    <!-- ===== FORM (Siding Info above More Info) ===== -->
    <form id="tdhForm" class="grid" autocomplete="on">
      <div class="panel">
        <h2>General Info</h2>
        <div class="grid two">
          <div><label for="name">Name</label><input id="name" name="name" type="text" /></div>
          <div><label for="primaryContactName">Primary Contact Name</label><input id="primaryContactName" name="primaryContactName" type="text" /></div>
          <div><label for="primaryPhone">Primary Contact Phone Number</label><input id="primaryPhone" name="primaryPhone" type="tel" /></div>
          <div><label for="insuranceCompany">Insurance Company</label><input id="insuranceCompany" name="insuranceCompany" type="text" /></div>
          <div><label for="claimNumber">Claim Number</label><input id="claimNumber" name="claimNumber" type="text" /></div>
          <div><label for="phone">Phone</label><input id="phone" name="phone" type="tel" /></div>
          <div><label for="address">Address</label><input id="address" name="address" type="text" /></div>
          <div><label for="cityStateZip">City, State, Zip</label><input id="cityStateZip" name="cityStateZip" type="text" /></div>
        </div>
      </div>

      <div class="panel">
        <h2>Roofing Info</h2>
        <div class="checks">
          <label><input type="checkbox" name="roofingLocations" value="House">House</label>
          <label><input type="checkbox" name="roofingLocations" value="Garage">Garage</label>
          <label><input type="checkbox" name="roofingLocations" value="Shed">Shed</label>
          <label><input type="checkbox" name="roofingLocations" value="Flat">Flat</label>
        </div>
        <div class="grid two" style="margin-top:10px">
          <div><label for="tearOffLayers">Tear off layers</label><input id="tearOffLayers" name="tearOffLayers" type="number" min="0" step="1" /></div>
          <div>
            <label>Underlayment</label>
            <div class="checks">
              <label><input type="radio" name="underlayment" value="15lb">15lb</label>
              <label><input type="radio" name="underlayment" value="30lb">30lb</label>
              <label><input type="radio" name="underlayment" value="Synthetic">Synthetic</label>
            </div>
          </div>
          <div><label for="shinglesBrand">Shingles Brand</label><input id="shinglesBrand" name="shinglesBrand" type="text" /></div>
          <div><label for="style">Style</label><input id="style" name="style" type="text" /></div>
          <div><label for="color">Color</label><input id="color" name="color" type="text" /></div>
          <div><label for="sqs">SQs</label><input id="sqs" name="sqs" type="text" /></div>
          <div><label for="iceWater">Ice & Water Barrier (per code)</label><input id="iceWater" name="iceWater" type="text" /></div>
          <div><label for="dripEdge">Drip Edge (Color)</label><input id="dripEdge" name="dripEdge" type="text" /></div>
          <div><label for="gutterApron">Gutter Apron (Color)</label><input id="gutterApron" name="gutterApron" type="text" /></div>
          <div><label for="vents">Vents (Color / Type / Qty)</label><input id="vents" name="vents" type="text" /></div>
          <div><label for="valleys">Valleys (Color / Open or Closed)</label><input id="valleys" name="valleys" type="text" /></div>
          <div><label for="pipeJacks">Pipe Jacks (QTY / Type)</label><input id="pipeJacks" name="pipeJacks" type="text" /></div>
          <div><label for="roofPitch">Roof Pitch</label><input id="roofPitch" name="roofPitch" type="text" /></div>
          <div><label for="stories">Stories</label><input id="stories" name="stories" type="number" min="0" step="1" /></div>
          <div><label for="roofSize">Size</label><input id="roofSize" name="roofSize" type="text" /></div>
          <div>
            <label>Roof Type</label>
            <div class="checks">
              <label><input type="checkbox" name="roofType" value="Hip">Hip</label>
              <label><input type="checkbox" name="roofType" value="Gable">Gable</label>
              <label><input type="checkbox" name="roofType" value="Both">Both</label>
            </div>
          </div>
          <div><label for="ridgeCap">Ridge Cap</label><input id="ridgeCap" name="ridgeCap" type="text" /></div>
          <div><label for="ridgeVent">Ridge Vent</label><input id="ridgeVent" name="ridgeVent" type="text" /></div>
          <div><label for="sideWallFlashing">Side Wall Flashing (Color / Metal or Plastic)</label><input id="sideWallFlashing" name="sideWallFlashing" type="text" /></div>
        </div>
      </div>

      <!-- Siding Info ABOVE More Info -->
      <div class="panel">
        <h2>Siding Info</h2>
        <div class="grid two">
          <div><label for="sidingBrand">Brand</label><input id="sidingBrand" name="sidingBrand" type="text" /></div>
          <div><label for="sidingStyle">Style</label><input id="sidingStyle" name="sidingStyle" type="text" /></div>
          <div><label for="sidingSqs">SQs</label><input id="sidingSqs" name="sidingSqs" type="text" /></div>
          <div><label for="sidingColor">Color</label><input id="sidingColor" name="sidingColor" type="text" /></div>
          <div>
            <label>Elevations</label>
            <div class="checks">
              <label><input type="checkbox" name="elevations" value="Front">Front</label>
              <label><input type="checkbox" name="elevations" value="Right">Right</label>
              <label><input type="checkbox" name="elevations" value="Left">Left</label>
              <label><input type="checkbox" name="elevations" value="Rear">Rear</label>
            </div>
          </div>
          <div><label for="trim">Trim</label><input id="trim" name="trim" type="text" /></div>
          <div>
            <label>Fascia</label>
            <div class="checks">
              <label><input type="radio" name="fascia" value="Smooth">Smooth</label>
              <label><input type="radio" name="fascia" value="PVC">PVC</label>
            </div>
          </div>
          <div><label for="fasciaColor">Fascia Color</label><input id="fasciaColor" name="fasciaColor" type="text" /></div>
          <div>
            <label>Soffit</label>
            <div class="checks">
              <label><input type="radio" name="soffit" value="Solid">Solid</label>
              <label><input type="radio" name="soffit" value="Vented">Vented</label>
            </div>
          </div>
          <div><label for="soffitColor">Soffit Color</label><input id="soffitColor" name="soffitColor" type="text" /></div>
          <div>
            <label>Window Wraps</label>
            <div class="checks">
              <label><input type="radio" name="windowWraps" value="Smooth">Smooth</label>
              <label><input type="radio" name="windowWraps" value="PVC">PVC</label>
            </div>
          </div>
          <div><label for="windowWrapsColor">Window Wraps Color</label><input id="windowWrapsColor" name="windowWrapsColor" type="text" /></div>
          <div>
            <label>Blocks</label>
            <div class="checks">
              <label><input type="checkbox" name="blocks" value="Light Blocks">Light Blocks</label>
              <label><input type="checkbox" name="blocks" value="Split Blocks">Split Blocks</label>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>More Info</h2>
        <div class="grid two">
          <div><label for="materialDrop">Material drop off</label><input id="materialDrop" name="materialDrop" type="text" /></div>
          <div><label for="redeck">Redeck (Partial or Full)</label><input id="redeck" name="redeck" type="text" /></div>
          <div><label for="interiorDamage">Interior damage</label><input id="interiorDamage" name="interiorDamage" type="text" /></div>
          <div><label for="cleanup">Cleanup</label><input id="cleanup" name="cleanup" type="text" /></div>
          <div style="grid-column:1/-1"><label for="miscNotes">Misc. Notes</label><textarea id="miscNotes" name="miscNotes"></textarea></div>
        </div>
      </div>

      <div class="panel">
        <h2>Payment Info</h2>
        <div class="grid two">
          <div><label for="agreedAmount">Agreed Amount ($)</label><input id="agreedAmount" name="agreedAmount" type="text" /></div>
          <div><label for="firstPayment">First Payment ($)</label><input id="firstPayment" name="firstPayment" type="text" /></div>
          <div><label for="finalPayment">Final Payment ($)</label><input id="finalPayment" name="finalPayment" type="text" /></div>
        </div>
      </div>

      <div class="panel">
        <h2>Signatures</h2>
        <div class="sig-row">
          <div><label for="custDate">Agreed to by Customer on date</label><input id="custDate" name="custDate" type="date" /></div>
          <div><label for="custSignature">Customer Signature (typed)</label><input id="custSignature" name="custSignature" type="text" placeholder="Sign here" /></div>
          <div><label for="tdhDate">Agreed to by TDH Representative on date</label><input id="tdhDate" name="tdhDate" type="date" /></div>
        </div>
        <div class="row" style="margin-top:10px">
          <label for="tdhSignature">TDH Representative Signature (typed)</label>
          <input id="tdhSignature" name="tdhSignature" type="text" placeholder="Sign here" />
        </div>
      </div>

      <div class="panel">
        <h2>Instructions</h2>
        <div class="row">
          <label for="instructions">Location</label>
          <input id="instructions" name="instructions" type="text" value="2513 River Rd Dr, Waterloo, NE 68069" />
        </div>
      </div>
    </form>
  </div>

<!-- ===== Robust jsPDF loader (tries local first, then CDNs) ===== -->
<script>
  async function ensureJsPDFLoaded(){
    if (window.jspdf && window.jspdf.jsPDF) return true;
    const sources = [
      "assets/jspdf.umd.min.js", // self-hosted fallback (upload this file to assets/)
      "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
      "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    ];
    for (const src of sources) {
      try {
        // eslint-disable-next-line no-await-in-loop
        await new Promise((res, rej) => {
          const s = document.createElement('script');
          s.src = src; s.async = true; s.onload = res; s.onerror = rej;
          document.head.appendChild(s);
        });
        if (window.jspdf && window.jspdf.jsPDF) return true;
      } catch (e) { /* try next */ }
    }
    alert("Couldn’t load the PDF engine (jsPDF). \n\nFix: upload jspdf.umd.min.js to assets/ or try again on a better connection.");
    return false;
  }
</script>

<script>
  /* ------------ helpers ------------ */
  function formToObject(form){
    const data={};
    new FormData(form).forEach((v,k)=>{
      if (data[k]!==undefined){ if(!Array.isArray(data[k])) data[k]=[data[k]]; data[k].push(v); }
      else data[k]=v;
    });
    return data;
  }
  function fillForm(form,obj){
    for(const el of form.elements){
      if(!el.name) continue;
      const v=obj[el.name]; if(v===undefined) continue;
      if(el.type==='checkbox') el.checked = Array.isArray(v) ? v.includes(el.value) : (v===el.value||v===true);
      else if(el.type==='radio') el.checked = (String(v)===el.value);
      else el.value = Array.isArray(v) ? v[0] : v;
    }
  }

  // Example data (optional)
  const example = {
    name:"Carol Chinn", address:"1185 N 9th St", cityStateZip:"David City, NE 68632-1227",
    primaryContactName:"Nate Wegner", primaryPhone:"(402) 707-7187",
    insuranceCompany:"State Farm", claimNumber:"2788S499V",
    roofingLocations:["House"], tearOffLayers:"1", underlayment:"Synthetic",
    shinglesBrand:"CertainTeed", style:"Landmark", color:"Desert Tan",
    sqs:"", iceWater:"", dripEdge:"White", gutterApron:"White",
    vents:"9 Turtle Type; White", valleys:"Open; Painted", pipeJacks:"2 EA NC",
    roofPitch:"4/12", stories:"1", roofSize:"1,050 SF", roofType:["Gable"],
    ridgeCap:"", ridgeVent:"", sideWallFlashing:"82 LF White; Metal",
    guttersSize:"6", guttersColor:"White", downspoutsSize:"3x4", downspoutsColor:"Bronze",
    gutterGuards:["Leaf Free"], gutterNotes:"Gutter Guards are Leafguard Brand; 121 LF White",
    materialDrop:"Driveway", redeck:"", interiorDamage:"", cleanup:"Mag Roll Sweeper; Clean and haul debris",
    miscNotes:"Satellite needs detached and reset; R&R 1 EA 6\" Rain cap",
    agreedAmount:"ACV", firstPayment:"RCV + Approved Supplements", finalPayment:"RCV + Approved Supplements",
    sidingBrand:"", sidingStyle:"", sidingSqs:"", sidingColor:"",
    elevations:["Front","Right","Left","Rear"], trim:"", fascia:"Smooth", fasciaColor:"",
    soffit:"Vented", soffitColor:"", windowWraps:"Smooth", windowWrapsColor:"", blocks:["Light Blocks","Split Blocks"],
    custDate:"", custSignature:"", tdhDate:"", tdhSignature:"", instructions:"2513 River Rd Dr, Waterloo, NE 68069"
  };

  const form = document.getElementById('tdhForm');
  document.getElementById('loadExample').addEventListener('click', ()=> fillForm(form, example));
  document.getElementById('clearForm').addEventListener('click', ()=> form.reset());
  document.getElementById('saveJson').addEventListener('click', ()=>{
    const data=formToObject(form);
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tdh-agreement.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  // ---- mapping (same as before) ----
  const PX_PER_IN = 150; // 1275px per 8.5in
  const layout = [
    {key:'name', x:180, y:230}, {key:'primaryContactName', x:780, y:230},
    {key:'primaryPhone', x:180, y:275}, {key:'insuranceCompany', x:780, y:275},
    {key:'claimNumber', x:180, y:320}, {key:'phone', x:780, y:320},
    {key:'address', x:180, y:365}, {key:'cityStateZip', x:780, y:365},
    {key:'x_roofing_House', x:160, y:430, mark:true},
    {key:'x_roofing_Garage', x:265, y:430, mark:true},
    {key:'x_roofing_Shed', x:370, y:430, mark:true},
    {key:'x_roofing_Flat', x:455, y:430, mark:true},
    {key:'tearOffLayers', x:220, y:465}, {key:'underlayment', x:780, y:465},
    {key:'shinglesBrand', x:180, y:505}, {key:'style', x:620, y:505}, {key:'color', x:960, y:505}, {key:'sqs', x:1160, y:505},
    {key:'iceWater', x:310, y:545},
    {key:'dripEdge', x:180, y:585}, {key:'gutterApron', x:620, y:585},
    {key:'vents', x:180, y:625}, {key:'valleys', x:620, y:625},
    {key:'pipeJacks', x:180, y:665}, {key:'roofPitch', x:620, y:665}, {key:'stories', x:880, y:665}, {key:'roofSize', x:1060, y:665},
    {key:'roofType', x:300, y:705}, {key:'ridgeCap', x:780, y:705}, {key:'ridgeVent', x:1060, y:705},
    {key:'sideWallFlashing', x:360, y:745},
    {key:'guttersSize', x:160, y:820}, {key:'guttersColor', x:420, y:820},
    {key:'downspoutsSize', x:750, y:820}, {key:'downspoutsColor', x:1020, y:820},
    {key:'gutterGuards', x:240, y:865}, {key:'gutterNotes', x:780, y:865},
    {key:'materialDrop', x:240, y:940}, {key:'redeck', x:740, y:940},
    {key:'interiorDamage', x:240, y:980}, {key:'cleanup', x:740, y:980},
    {key:'miscNotes', x:240, y:1020, w:900},
    {key:'agreedAmount', x:240, y:1085}, {key:'firstPayment', x:740, y:1085}, {key:'finalPayment', x:1040, y:1085},
    {key:'sidingBrand', x:180, y:1150}, {key:'sidingStyle', x:620, y:1150}, {key:'sidingSqs', x:980, y:1150}, {key:'sidingColor', x:1160, y:1150},
    {key:'elevations', x:240, y:1190}, {key:'trim', x:740, y:1190},
    {key:'fascia', x:240, y:1230}, {key:'fasciaColor', x:620, y:1230},
    {key:'soffit', x:920, y:1230}, {key:'soffitColor', x:1160, y:1230},
    {key:'windowWraps', x:240, y:1270}, {key:'windowWrapsColor', x:620, y:1270},
    {key:'blocks', x:240, y:1310},
    {key:'custDate', x:320, y:1380}, {key:'custSignature', x:680, y:1380},
    {key:'tdhDate', x:320, y:1415}, {key:'tdhSignature', x:680, y:1415},
    {key:'instructions', x:360, y:1475}
  ];

  function computeValues(d){
    const out = {};
    const list = v => Array.isArray(v) ? v.join(', ') : (v || '');
    Object.assign(out, {
      name:d.name, primaryContactName:d.primaryContactName, primaryPhone:d.primaryPhone,
      insuranceCompany:d.insuranceCompany, claimNumber:d.claimNumber, phone:d.phone,
      address:d.address, cityStateZip:d.cityStateZip,
      tearOffLayers:d.tearOffLayers||'', underlayment:d.underlayment||'',
      shinglesBrand:d.shinglesBrand||'', style:d.style||'', color:d.color||'', sqs:d.sqs||'',
      iceWater:d.iceWater||'', dripEdge:d.dripEdge||'', gutterApron:d.gutterApron||'',
      vents:d.vents||'', valleys:d.valleys||'', pipeJacks:d.pipeJacks||'',
      roofPitch:d.roofPitch||'', stories:d.stories||'', roofSize:d.roofSize||'',
      roofType:list(d.roofType), ridgeCap:d.ridgeCap||'', ridgeVent:d.ridgeVent||'',
      sideWallFlashing:d.sideWallFlashing||'',
      guttersSize:d.guttersSize? d.guttersSize + '"' : '', guttersColor:d.guttersColor||'',
      downspoutsSize:d.downspoutsSize||'', downspoutsColor:d.downspoutsColor||'',
      gutterGuards:list(d.gutterGuards), gutterNotes:d.gutterNotes||'',
      materialDrop:d.materialDrop||'', redeck:d.redeck||'', interiorDamage:d.interiorDamage||'',
      cleanup:d.cleanup||'', miscNotes:d.miscNotes||'',
      agreedAmount:d.agreedAmount||'', firstPayment:d.firstPayment||'', finalPayment:d.finalPayment||'',
      sidingBrand:d.sidingBrand||'', sidingStyle:d.sidingStyle||'', sidingSqs:d.sidingSqs||'', sidingColor:d.sidingColor||'',
      elevations:list(d.elevations), trim:d.trim||'', fascia:d.fascia||'', fasciaColor:d.fasciaColor||'',
      soffit:d.soffit||'', soffitColor:d.soffitColor||'', windowWraps:d.windowWraps||'',
      windowWrapsColor:d.windowWrapsColor||'', blocks:list(d.blocks),
      custDate:d.custDate||'', custSignature:d.custSignature||'', tdhDate:d.tdhDate||'', tdhSignature:d.tdhSignature||'',
      instructions:d.instructions||''
    });
    const loc = new Set([].concat(d.roofingLocations||[]));
    out.x_roofing_House  = loc.has('House') ? 'X' : '';
    out.x_roofing_Garage = loc.has('Garage') ? 'X' : '';
    out.x_roofing_Shed   = loc.has('Shed') ? 'X' : '';
    out.x_roofing_Flat   = loc.has('Flat') ? 'X' : '';
    return out;
  }

  // ---- DOWNLOAD: draw template + text directly into PDF (single page) ----
  document.getElementById('downloadPdf').addEventListener('click', async ()=>{
    try {
      // 1) Ensure jsPDF is available
      if (!(await ensureJsPDFLoaded())) return;
      const { jsPDF } = window.jspdf;

      // 2) Load template image (must exist at /assets/tdh-template.png)
      const imgUrl = 'assets/tdh-template.png';
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = imgUrl;
      await new Promise((res, rej)=>{
        img.onload = res;
        img.onerror = ()=> rej(new Error('Template image not found at ' + imgUrl));
      });

      // 3) Build PDF (always one US Letter page)
      const doc = new jsPDF({ unit:'in', format:'letter', compress:true });

      // 4) Background
      doc.addImage(img, 'PNG', 0, 0, 8.5, 11);

      // 5) Text overlay
      const data = formToObject(form);
      const v = computeValues(data);
      doc.setTextColor(0,0,0);
      doc.setFont('times', 'normal');
      doc.setFontSize(11);

      layout.forEach(item=>{
        const val = v[item.key] || '';
        if (!val) return;
        const xIn = item.x / PX_PER_IN;
        const yIn = item.y / PX_PER_IN;

        if (item.mark) {
          doc.setFont('helvetica','bold'); doc.setFontSize(12);
          doc.text('X', xIn, yIn);
          doc.setFont('times','normal'); doc.setFontSize(11);
          return;
        }
        if (item.w) {
          const wIn = item.w / PX_PER_IN;
          const lines = doc.splitTextToSize(String(val), wIn);
          doc.text(lines, xIn, yIn);
        } else {
          doc.text(String(val), xIn, yIn);
        }
      });

      // 6) Save
      const filename = `TDH_Agreement_${(data.name||'Filled').replace(/\s+/g,'_')}.pdf`;
      doc.save(filename);
    } catch (err) {
      console.error(err);
      alert(
        "Couldn’t generate the PDF.\n\n" +
        "Quick checks:\n" +
        "• Is jsPDF available? Try uploading assets/jspdf.umd.min.js\n" +
        "• Does assets/tdh-template.png exist (exact name/path)?\n" +
        "• Hard-refresh the page (Cmd/Ctrl+Shift+R)."
      );
    }
  });

  // Autosave while typing (nice for mobile)
  const KEY='tdh-agreement-autosave';
  try { const saved=JSON.parse(localStorage.getItem(KEY)||'null'); if (saved) fillForm(form, saved); } catch {}
  form.addEventListener('input', ()=> localStorage.setItem(KEY, JSON.stringify(formToObject(form))));
</script>
</body>
</html>
