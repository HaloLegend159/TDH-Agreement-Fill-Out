<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TDH Agreement – Exact PDF (Calibrate + Mobile)</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --gap:14px; --radius:14px; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1100px;margin:20px auto;padding:0 12px 80px}
  .toolbar{
    position:sticky;top:0;z-index:20;backdrop-filter:blur(6px);
    background:color-mix(in oklab,var(--bg) 85%, transparent);
    display:flex;gap:8px;padding:10px 0 14px;align-items:center;flex-wrap:wrap
  }
  .toolbar h1{margin:0;font-size:18px;margin-right:auto}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button{
    border:1px solid var(--border);background:#0b1324;color:var(--ink);
    padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600
  }
  button.primary{background:#1a2a4b}
  button:hover{background:#101a33}
  .grid{display:grid;gap:var(--gap)}
  .two{grid-template-columns:1fr 1fr}
  .panel{
    background:var(--panel);border:1px solid var(--border);
    border-radius:var(--radius);padding:16px
  }
  .panel h2{margin:0 0 10px;font-size:16px;font-weight:700}
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}

  /* Pretty inputs */
  input[type="text"], input[type="tel"], input[type="number"], input[type="date"], textarea, select{
    width:100%; background:#0b1220; color:var(--ink);
    border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none;
    appearance:none; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    transition:border-color .2s, box-shadow .2s, background .2s
  }
  input::placeholder, textarea::placeholder{ color:#64748b; opacity:.9 }
  input:hover, textarea:hover, select:hover{ border-color:#334155; background:#0d1527 }
  input:focus, textarea:focus, select:focus{ border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25); background:#0a152b }
  input[type="checkbox"], input[type="radio"]{ accent-color:#3b82f6 }

  .checks{display:flex;flex-wrap:wrap;gap:10px 16px}
  .checks label{display:inline-flex;align-items:center;gap:8px;margin:0}
  .sig-row{display:grid;gap:10px;grid-template-columns:1.2fr 1fr 1.2fr;align-items:end}
  .row{display:grid;gap:10px;grid-template-columns:160px 1fr;align-items:center}
  .logo-box{display:flex;align-items:center;gap:8px}
  .logo-box img{height:28px;width:auto;object-fit:contain}

  /* ===== Calibrate overlay ===== */
  #calibWrap{display:none;margin-top:14px}
  .page {
    position: relative;
    width: 1275px;   /* design frame (≈150 px/in) */
    height: 1650px;  /* 8.5 x 11 in */
    background:#fff url('assets/tdh-template.png') center/cover no-repeat;
    border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .field, .check {
    position:absolute; color:#111;
    font-family: "Times New Roman", Times, serif;
    font-size: 20px; line-height:1.1;
    white-space: pre;
    user-select: none;
  }
  .check { font-weight: 800; font-size: 22px; }
  .calib-selected { outline:2px solid rgba(59,130,246,.9) !important; border-radius:6px; }
  .calib-draggable { outline:1px dashed rgba(0,0,0,.45); cursor:move; padding:1px 2px; border-radius:4px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="logo-box">
        <img src="assets/tdh-logo.png" alt="" onerror="this.style.display='none'">
        <h1>TDH Agreement (Editable)</h1>
      </div>
      <div class="actions">
        <button type="button" id="loadExample">Load Example</button>
        <button type="button" id="clearForm">Clear</button>
        <button type="button" id="saveJson">Save JSON</button>
        <button type="button" class="primary" id="downloadPdf"><strong>Download PDF</strong></button>
        <button type="button" id="toggleCalib">Calibrate</button>
        <button type="button" id="fillFromForm">Use Current Form Values</button>
        <button type="button" id="copyLayout">Copy Layout JSON</button>
        <button type="button" id="saveLayout">Download Layout JSON</button>
        <button type="button" id="resetLayout">Reset Layout</button>
      </div>
    </div>

    <!-- ===== FORM (Siding Info above More Info + Gutters panel) ===== -->
    <form id="tdhForm" class="grid" autocomplete="on">
      <div class="panel">
        <h2>General Info</h2>
        <div class="grid two">
          <div><label for="name">Name</label><input id="name" name="name" type="text" /></div>
          <div><label for="primaryContactName">Primary Contact Name</label><input id="primaryContactName" name="primaryContactName" type="text" /></div>
          <div><label for="primaryPhone">Primary Contact Phone Number</label><input id="primaryPhone" name="primaryPhone" type="tel" /></div>
          <div><label for="insuranceCompany">Insurance Company</label><input id="insuranceCompany" name="insuranceCompany" type="text" /></div>
          <div><label for="claimNumber">Claim Number</label><input id="claimNumber" name="claimNumber" type="text" /></div>
          <div><label for="phone">Phone</label><input id="phone" name="phone" type="tel" /></div>
          <div><label for="address">Address</label><input id="address" name="address" type="text" /></div>
          <div><label for="cityStateZip">City, State, Zip</label><input id="cityStateZip" name="cityStateZip" type="text" /></div>
        </div>
      </div>

      <div class="panel">
        <h2>Roofing Info</h2>
        <div class="checks">
          <label><input type="checkbox" name="roofingLocations" value="House">House</label>
          <label><input type="checkbox" name="roofingLocations" value="Garage">Garage</label>
          <label><input type="checkbox" name="roofingLocations" value="Shed">Shed</label>
          <label><input type="checkbox" name="roofingLocations" value="Flat">Flat</label>
        </div>
        <div class="grid two" style="margin-top:10px">
          <div><label for="tearOffLayers">Tear off layers</label><input id="tearOffLayers" name="tearOffLayers" type="number" min="0" step="1" /></div>
          <div>
            <label>Underlayment</label>
            <div class="checks">
              <label><input type="radio" name="underlayment" value="15lb">15lb</label>
              <label><input type="radio" name="underlayment" value="30lb">30lb</label>
              <label><input type="radio" name="underlayment" value="Synthetic">Synthetic</label>
            </div>
          </div>
          <div><label for="shinglesBrand">Shingles Brand</label><input id="shinglesBrand" name="shinglesBrand" type="text" /></div>
          <div><label for="style">Style</label><input id="style" name="style" type="text" /></div>
          <div><label for="color">Color</label><input id="color" name="color" type="text" /></div>
          <div><label for="sqs">SQs</label><input id="sqs" name="sqs" type="text" /></div>
          <div><label for="iceWater">Ice &amp; Water Barrier (per code)</label><input id="iceWater" name="iceWater" type="text" /></div>
          <div><label for="dripEdge">Drip Edge (Color)</label><input id="dripEdge" name="dripEdge" type="text" /></div>
          <div><label for="gutterApron">Gutter Apron (Color)</label><input id="gutterApron" name="gutterApron" type="text" /></div>
          <div><label for="vents">Vents (Color / Type / Qty)</label><input id="vents" name="vents" type="text" placeholder="e.g., 9 Turtle Type; White" /></div>
          <div><label for="valleys">Valleys (Color / Open or Closed)</label><input id="valleys" name="valleys" type="text" placeholder="e.g., Painted; Open" /></div>
          <div><label for="pipeJacks">Pipe Jacks (QTY / Type)</label><input id="pipeJacks" name="pipeJacks" type="text" /></div>
          <div><label for="roofPitch">Roof Pitch</label><input id="roofPitch" name="roofPitch" type="text" /></div>
          <div><label for="stories">Stories</label><input id="stories" name="stories" type="number" min="0" step="1" /></div>
          <div><label for="roofSize">Size</label><input id="roofSize" name="roofSize" type="text" /></div>
          <div>
            <label>Roof Type</label>
            <div class="checks">
              <label><input type="checkbox" name="roofType" value="Hip">Hip</label>
              <label><input type="checkbox" name="roofType" value="Gable">Gable</label>
              <label><input type="checkbox" name="roofType" value="Both">Both</label>
            </div>
          </div>
          <div><label for="ridgeCap">Ridge Cap</label><input id="ridgeCap" name="ridgeCap" type="text" /></div>
          <div><label for="ridgeVent">Ridge Vent</label><input id="ridgeVent" name="ridgeVent" type="text" /></div>
          <div><label for="sideWallFlashing">Side Wall Flashing (Color / Metal or Plastic)</label><input id="sideWallFlashing" name="sideWallFlashing" type="text" /></div>
        </div>
      </div>

      <div class="panel">
        <h2>Gutters</h2>
        <div class="grid two">
          <div>
            <label>Gutters Size</label>
            <div class="checks">
              <label><input type="radio" name="guttersSize" value="5">5"</label>
              <label><input type="radio" name="guttersSize" value="6">6"</label>
            </div>
          </div>
          <div><label for="guttersColor">Gutters Color</label><input id="guttersColor" name="guttersColor" type="text" /></div>
          <div>
            <label>Downspouts Size</label>
            <div class="checks">
              <label><input type="radio" name="downspoutsSize" value="2x3">2×3</label>
              <label><input type="radio" name="downspoutsSize" value="3x4">3×4</label>
            </div>
          </div>
          <div><label for="downspoutsColor">Downspouts Color</label><input id="downspoutsColor" name="downspoutsColor" type="text" /></div>
          <div>
            <label>Gutter Guards</label>
            <div class="checks">
              <label><input type="checkbox" name="gutterGuards" value="Plastic">Plastic</label>
              <label><input type="checkbox" name="gutterGuards" value="RX">RX</label>
              <label><input type="checkbox" name="gutterGuards" value="Leaf Free">Leaf Free</label>
            </div>
          </div>
          <div><label for="gutterNotes">Gutter Notes</label><input id="gutterNotes" name="gutterNotes" type="text" /></div>
        </div>
      </div>

      <!-- Siding Info ABOVE More Info -->
      <div class="panel">
        <h2>Siding Info</h2>
        <div class="grid two">
          <div><label for="sidingBrand">Brand</label><input id="sidingBrand" name="sidingBrand" type="text" /></div>
          <div><label for="sidingStyle">Style</label><input id="sidingStyle" name="sidingStyle" type="text" /></div>
          <div><label for="sidingSqs">SQs</label><input id="sidingSqs" name="sidingSqs" type="text" /></div>
          <div><label for="sidingColor">Color</label><input id="sidingColor" name="sidingColor" type="text" /></div>
          <div>
            <label>Elevations</label>
            <div class="checks">
              <label><input type="checkbox" name="elevations" value="Front">Front</label>
              <label><input type="checkbox" name="elevations" value="Right">Right</label>
              <label><input type="checkbox" name="elevations" value="Left">Left</label>
              <label><input type="checkbox" name="elevations" value="Rear">Rear</label>
            </div>
          </div>
          <div><label for="trim">Trim</label><input id="trim" name="trim" type="text" /></div>
          <div>
            <label>Fascia</label>
            <div class="checks">
              <label><input type="radio" name="fascia" value="Smooth">Smooth</label>
              <label><input type="radio" name="fascia" value="PVC">PVC</label>
            </div>
          </div>
          <div><label for="fasciaColor">Fascia Color</label><input id="fasciaColor" name="fasciaColor" type="text" /></div>
          <div>
            <label>Soffit</label>
            <div class="checks">
              <label><input type="radio" name="soffit" value="Solid">Solid</label>
              <label><input type="radio" name="soffit" value="Vented">Vented</label>
            </div>
          </div>
          <div><label for="soffitColor">Soffit Color</label><input id="soffitColor" name="soffitColor" type="text" /></div>
          <div>
            <label>Window Wraps</label>
            <div class="checks">
              <label><input type="radio" name="windowWraps" value="Smooth">Smooth</label>
              <label><input type="radio" name="windowWraps" value="PVC">PVC</label>
            </div>
          </div>
          <div><label for="windowWrapsColor">Window Wraps Color</label><input id="windowWrapsColor" name="windowWrapsColor" type="text" /></div>
          <div>
            <label>Blocks</label>
            <div class="checks">
              <label><input type="checkbox" name="blocks" value="Light Blocks">Light Blocks</label>
              <label><input type="checkbox" name="blocks" value="Split Blocks">Split Blocks</label>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>More Info</h2>
        <div class="grid two">
          <div><label for="materialDrop">Material drop off</label><input id="materialDrop" name="materialDrop" type="text" /></div>
          <div><label for="redeck">Redeck (Partial or Full)</label><input id="redeck" name="redeck" type="text" /></div>
          <div><label for="interiorDamage">Interior damage</label><input id="interiorDamage" name="interiorDamage" type="text" /></div>
          <div><label for="cleanup">Cleanup</label><input id="cleanup" name="cleanup" type="text" /></div>
          <div style="grid-column:1/-1"><label for="miscNotes">Misc. Notes</label><textarea id="miscNotes" name="miscNotes"></textarea></div>
        </div>
      </div>

      <div class="panel">
        <h2>Payment Info</h2>
        <div class="grid two">
          <div><label for="agreedAmount">Agreed Amount ($)</label><input id="agreedAmount" name="agreedAmount" type="text" /></div>
          <div><label for="firstPayment">First Payment ($)</label><input id="firstPayment" name="firstPayment" type="text" /></div>
          <div><label for="finalPayment">Final Payment ($)</label><input id="finalPayment" name="finalPayment" type="text" /></div>
        </div>
      </div>

      <div class="panel">
        <h2>Signatures</h2>
        <div class="sig-row">
          <div><label for="custDate">Agreed to by Customer on date</label><input id="custDate" name="custDate" type="date" /></div>
          <div><label for="custSignature">Customer Signature (typed)</label><input id="custSignature" name="custSignature" type="text" placeholder="Sign here" /></div>
          <div><label for="tdhDate">Agreed to by TDH Representative on date</label><input id="tdhDate" name="tdhDate" type="date" /></div>
        </div>
        <div class="row" style="margin-top:10px">
          <label for="tdhSignature">TDH Representative Signature (typed)</label>
          <input id="tdhSignature" name="tdhSignature" type="text" placeholder="Sign here" />
        </div>
      </div>

      <div class="panel">
        <h2>Instructions</h2>
        <div class="row">
          <label for="instructions">Location</label>
          <input id="instructions" name="instructions" type="text" value="2513 River Rd Dr, Waterloo, NE 68069" />
        </div>
      </div>
    </form>

    <!-- ===== Calibrate overlay ===== -->
    <div id="calibWrap">
      <div class="page" id="calibPage"></div>
      <p style="color:#94a3b8;margin:.5rem 0 0">
        Tip: Drag labels/X’s to align. Use arrow keys to nudge (Shift = 10px). When done, Copy or Download Layout JSON and send it to me if you want it baked in.
      </p>
    </div>
  </div>

<!-- ===== jsPDF loader: local then CDNs ===== -->
<script>
async function ensureJsPDFLoaded(){
  if (window.jspdf && window.jspdf.jsPDF) return true;
  const sources = [
    "assets/jspdf.umd.min.js",
    "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
    "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
  ];
  for (const src of sources) {
    try {
      await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      if (window.jspdf && window.jspdf.jsPDF) return true;
    } catch(e){}
  }
  alert("Couldn’t load the PDF engine (jsPDF). Upload assets/jspdf.umd.min.js or try again.");
  return false;
}
async function loadTemplateImage(){
  const candidates = [
    'assets/tdh-template.png',
    './assets/tdh-template.png',
    new URL('assets/tdh-template.png', document.baseURI).href
  ];
  for (const url of [...new Set(candidates)]) {
    try {
      const img = new Image(); img.crossOrigin='anonymous'; img.src=url;
      await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
      return img;
    } catch(e){}
  }
  throw new Error('Template image not found. Ensure assets/tdh-template.png exists.');
}
</script>

<script>
/* ---------- helpers ---------- */
function formToObject(form){
  const data={};
  new FormData(form).forEach((v,k)=>{
    if (data[k]!==undefined){ if(!Array.isArray(data[k])) data[k]=[data[k]]; data[k].push(v); }
    else data[k]=v;
  });
  return data;
}
function fillForm(form,obj){
  for(const el of form.elements){
    if(!el.name) continue;
    const v=obj[el.name]; if(v===undefined) continue;
    if(el.type==='checkbox') el.checked = Array.isArray(v) ? v.includes(el.value) : (v===el.value||v===true);
    else if(el.type==='radio') el.checked = (String(v)===el.value);
    else el.value = Array.isArray(v) ? v[0] : v;
  }
}

/* ---------- values → printed text + X markers ---------- */
function computeValues(d){
  const out = {};
  const list = v => Array.isArray(v) ? v.join(', ') : (v || '');

  // Plain text lines
  Object.assign(out, {
    name:d.name, primaryContactName:d.primaryContactName, primaryPhone:d.primaryPhone,
    insuranceCompany:d.insuranceCompany, claimNumber:d.claimNumber, phone:d.phone,
    address:d.address, cityStateZip:d.cityStateZip,
    shinglesBrand:d.shinglesBrand||'', style:d.style||'', color:d.color||'', sqs:d.sqs||'',
    iceWater:d.iceWater||'', dripEdge:d.dripEdge||'', gutterApron:d.gutterApron||'',
    pipeJacks:d.pipeJacks||'', roofPitch:d.roofPitch||'', stories:d.stories||'',
    roofSize:d.roofSize||'', ridgeCap:d.ridgeCap||'', ridgeVent:d.ridgeVent||'',
    sideWallFlashing:d.sideWallFlashing||'',
    guttersColor:d.guttersColor||'', downspoutsColor:d.downspoutsColor||'',
    gutterNotes:d.gutterNotes||'',
    materialDrop:d.materialDrop||'', redeck:d.redeck||'', interiorDamage:d.interiorDamage||'',
    cleanup:d.cleanup||'', miscNotes:d.miscNotes||'',
    agreedAmount:d.agreedAmount||'', firstPayment:d.firstPayment||'', finalPayment:d.finalPayment||'',
    sidingBrand:d.sidingBrand||'', sidingStyle:d.sidingStyle||'', sidingSqs:d.sidingSqs||'', sidingColor:d.sidingColor||'',
    trim:d.trim||'', fasciaColor:d.fasciaColor||'', soffitColor:d.soffitColor||'',
    windowWrapsColor:d.windowWrapsColor||'',
    custDate:d.custDate||'', custSignature:d.custSignature||'', tdhDate:d.tdhDate||'', tdhSignature:d.tdhSignature||'',
    instructions:d.instructions||'',
  });

  // Roofing locations → X
  const roofingLoc = new Set([].concat(d.roofingLocations||[]));
  out.x_roofing_House  = roofingLoc.has('House')  ? 'X' : '';
  out.x_roofing_Garage = roofingLoc.has('Garage') ? 'X' : '';
  out.x_roofing_Shed   = roofingLoc.has('Shed')   ? 'X' : '';
  out.x_roofing_Flat   = roofingLoc.has('Flat')   ? 'X' : '';

  // Underlayment radios → X (no word output)
  out.x_underlayment_15lb      = d.underlayment==='15lb'      ? 'X' : '';
  out.x_underlayment_30lb      = d.underlayment==='30lb'      ? 'X' : '';
  out.x_underlayment_Synthetic = d.underlayment==='Synthetic' ? 'X' : '';

  // Gutters sizes → X
  out.x_gutters_5 = d.guttersSize==='5' ? 'X' : '';
  out.x_gutters_6 = d.guttersSize==='6' ? 'X' : '';

  // Downspouts sizes → X
  out.x_downspouts_2x3 = d.downspoutsSize==='2x3' ? 'X' : '';
  out.x_downspouts_3x4 = d.downspoutsSize==='3x4' ? 'X' : '';

  // Roof Type checkboxes → X
  const roofType = new Set([].concat(d.roofType||[]));
  out.x_roofType_Hip   = roofType.has('Hip')   ? 'X' : '';
  out.x_roofType_Gable = roofType.has('Gable') ? 'X' : '';
  out.x_roofType_Both  = roofType.has('Both')  ? 'X' : '';

  // Gutter Guards → X
  const guards = new Set([].concat(d.gutterGuards||[]));
  out.x_guard_Plastic  = guards.has('Plastic')   ? 'X' : '';
  out.x_guard_RX       = guards.has('RX')        ? 'X' : '';
  out.x_guard_LeafFree = guards.has('Leaf Free') ? 'X' : '';

  // Fascia → X
  out.x_fascia_Smooth = d.fascia==='Smooth' ? 'X' : '';
  out.x_fascia_PVC    = d.fascia==='PVC'    ? 'X' : '';

  // Soffit → X
  out.x_soffit_Solid  = d.soffit==='Solid'  ? 'X' : '';
  out.x_soffit_Vented = d.soffit==='Vented' ? 'X' : '';

  // Window Wraps → X
  out.x_wraps_Smooth = d.windowWraps==='Smooth' ? 'X' : '';
  out.x_wraps_PVC    = d.windowWraps==='PVC'    ? 'X' : '';

  // Vents: print your text AND X "Turtle" if mentioned
  const ventsStr = String(d.vents || '');
  out.vents = ventsStr;
  const turtleRe = /\b(turtle\s*vents?|turtle\s*type|turtle)\b/i;
  out.x_vents_Turtle = turtleRe.test(ventsStr) ? 'X' : '';

  // Valleys: X Open/Closed + print remaining (e.g., color)
  const valleysStr = String(d.valleys || '');
  const hasOpen   = /(^|\b)open\b/i.test(valleysStr);
  const hasClosed = /(^|\b)closed\b/i.test(valleysStr);
  out.x_valley_Open   = hasOpen   ? 'X' : '';
  out.x_valley_Closed = hasClosed ? 'X' : '';
  out.valleys_text = valleysStr.replace(/\b(open|closed)\b/ig, '').replace(/^\s*;?\s*|\s*;?\s*$/g,'').trim();

  // Keep as text:
  out.tearOffLayers = d.tearOffLayers||'';

  return out;
}
</script>

<script>
/* ---------- layout (defaults) + persist ---------- */
const PAGE_W = 1275, PAGE_H = 1650; // design frame
const LKEY='tdh-layout-v3';
let layout = JSON.parse(localStorage.getItem(LKEY) || 'null') || [
  // General Info
  {key:'name', x:180, y:230}, {key:'primaryContactName', x:780, y:230},
  {key:'primaryPhone', x:180, y:275}, {key:'insuranceCompany', x:780, y:275},
  {key:'claimNumber', x:180, y:320}, {key:'phone', x:780, y:320},
  {key:'address', x:180, y:365}, {key:'cityStateZip', x:780, y:365},

  // Roofing locations (X)
  {key:'x_roofing_House',  x:160, y:430, cls:'check'},
  {key:'x_roofing_Garage', x:265, y:430, cls:'check'},
  {key:'x_roofing_Shed',   x:370, y:430, cls:'check'},
  {key:'x_roofing_Flat',   x:455, y:430, cls:'check'},

  // Tear off (text)
  {key:'tearOffLayers', x:220, y:465},

  // Underlayment (X)
  {key:'x_underlayment_15lb',      x:620, y:465, cls:'check'},
  {key:'x_underlayment_30lb',      x:725, y:465, cls:'check'},
  {key:'x_underlayment_Synthetic', x:870, y:465, cls:'check'},

  // Shingles / misc (text)
  {key:'shinglesBrand', x:180, y:505}, {key:'style', x:620, y:505}, {key:'color', x:960, y:505}, {key:'sqs', x:1160, y:505},
  {key:'iceWater', x:310, y:545},
  {key:'dripEdge', x:180, y:585}, {key:'gutterApron', x:620, y:585},

  // Vents (text + Turtle X)
  {key:'vents', x:180, y:625},
  {key:'x_vents_Turtle', x:520, y:625, cls:'check'},

  // Valleys (Open/Closed X + color text)
  {key:'x_valley_Open',   x:900,  y:625, cls:'check'},
  {key:'x_valley_Closed', x:1040, y:625, cls:'check'},
  {key:'valleys_text',    x:1120, y:625},

  {key:'pipeJacks', x:180, y:665}, {key:'roofPitch', x:620, y:665}, {key:'stories', x:880, y:665}, {key:'roofSize', x:1060, y:665},

  // Roof Type (X)
  {key:'x_roofType_Hip',   x:300, y:705, cls:'check'},
  {key:'x_roofType_Gable', x:360, y:705, cls:'check'},
  {key:'x_roofType_Both',  x:430, y:705, cls:'check'},

  {key:'ridgeCap', x:780, y:705}, {key:'ridgeVent', x:1060, y:705},
  {key:'sideWallFlashing', x:360, y:745},

  // Gutters & Downspouts (sizes as X; colors as text)
  {key:'x_gutters_5', x:160, y:820, cls:'check'},
  {key:'x_gutters_6', x:210, y:820, cls:'check'},
  {key:'guttersColor', x:420, y:820},

  {key:'x_downspouts_2x3', x:750, y:820, cls:'check'},
  {key:'x_downspouts_3x4', x:820, y:820, cls:'check'},
  {key:'downspoutsColor', x:1020, y:820},

  // Gutter Guards (X) + Notes
  {key:'x_guard_Plastic',  x:240, y:865, cls:'check'},
  {key:'x_guard_RX',       x:320, y:865, cls:'check'},
  {key:'x_guard_LeafFree', x:420, y:865, cls:'check'},
  {key:'gutterNotes', x:780, y:865},

  // More / Siding / Payment / Signatures / Instructions
  {key:'materialDrop', x:240, y:940}, {key:'redeck', x:740, y:940},
  {key:'interiorDamage', x:240, y:980}, {key:'cleanup', x:740, y:980},
  {key:'miscNotes', x:240, y:1020, w:900},

  {key:'agreedAmount', x:240, y:1085}, {key:'firstPayment', x:740, y:1085}, {key:'finalPayment', x:1040, y:1085},

  {key:'sidingBrand', x:180, y:1150}, {key:'sidingStyle', x:620, y:1150}, {key:'sidingSqs', x:980, y:1150}, {key:'sidingColor', x:1160, y:1150},
  {key:'elevations', x:240, y:1190}, {key:'trim', x:740, y:1190},

  {key:'x_fascia_Smooth', x:240, y:1230, cls:'check'},
  {key:'x_fascia_PVC',    x:300, y:1230, cls:'check'},

  {key:'x_soffit_Solid',  x:920, y:1230, cls:'check'},
  {key:'x_soffit_Vented', x:1000, y:1230, cls:'check'},

  {key:'x_wraps_Smooth', x:240, y:1270, cls:'check'},
  {key:'x_wraps_PVC',    x:300, y:1270, cls:'check'},

  {key:'blocks', x:240, y:1310},

  {key:'custDate', x:320, y:1380}, {key:'custSignature', x:680, y:1380},
  {key:'tdhDate',  x:320, y:1415}, {key:'tdhSignature', x:680, y:1415},
  {key:'instructions', x:360, y:1475},
];
function saveLayout(){ try { localStorage.setItem(LKEY, JSON.stringify(layout)); } catch {} }
function resetLayout(){ localStorage.removeItem(LKEY); location.reload(); }
</script>

<script>
/* ---------- Calibrate UI (drag / nudge / copy) ---------- */
const calibWrap = document.getElementById('calibWrap');
const calibPage = document.getElementById('calibPage');
const btnCalib   = document.getElementById('toggleCalib');
const btnUseForm = document.getElementById('fillFromForm');
const btnCopy    = document.getElementById('copyLayout');
const btnSave    = document.getElementById('saveLayout');
const btnReset   = document.getElementById('resetLayout');

function mountOverlay(values){
  calibPage.innerHTML=''; // clear
  layout.forEach(item=>{
    const el = document.createElement('div');
    el.className = (item.cls || 'field') + ' calib-draggable';
    el.dataset.key = item.key;
    el.style.left = (item.x||0)+'px';
    el.style.top  = (item.y||0)+'px';
    if(item.w) el.style.width=item.w+'px';
    el.textContent = values[item.key] || '';
    calibPage.appendChild(el);
  });
}
let active = null, start = null;
calibPage.addEventListener('mousedown', e=>{
  const t=e.target.closest('.field,.check'); if (!t) return;
  if (active) active.classList.remove('calib-selected');
  active = t; active.classList.add('calib-selected');
  start = {x:e.clientX, y:e.clientY, l:parseFloat(t.style.left||0), t:parseFloat(t.style.top||0)};
  e.preventDefault();
});
window.addEventListener('mousemove', e=>{
  if (!active || !start) return;
  const dx=e.clientX-start.x, dy=e.clientY-start.y;
  active.style.left = Math.round(start.l+dx)+'px';
  active.style.top  = Math.round(start.t+dy)+'px';
});
window.addEventListener('mouseup', ()=>{
  if (!active || !start) return;
  const k=active.dataset.key;
  const node = layout.find(it=>it.key===k);
  node.x = Math.round(parseFloat(active.style.left||0));
  node.y = Math.round(parseFloat(active.style.top||0));
  saveLayout();
  start=null;
});
window.addEventListener('keydown', (e)=>{
  if (!active || calibWrap.style.display!=='block') return;
  const step = e.shiftKey ? 10 : 1;
  const left = parseFloat(active.style.left||0);
  const top  = parseFloat(active.style.top||0);
  if (e.key==='ArrowLeft')  active.style.left = (left - step) + 'px';
  if (e.key==='ArrowRight') active.style.left = (left + step) + 'px';
  if (e.key==='ArrowUp')    active.style.top  = (top  - step) + 'px';
  if (e.key==='ArrowDown')  active.style.top  = (top  + step) + 'px';
  const k=active.dataset.key;
  const node = layout.find(it=>it.key===k);
  node.x = Math.round(parseFloat(active.style.left||0));
  node.y = Math.round(parseFloat(active.style.top||0));
  saveLayout();
});

btnCalib.addEventListener('click', ()=>{
  const show = calibWrap.style.display !== 'block';
  calibWrap.style.display = show ? 'block' : 'none';
  if (show) {
    const v = computeValues(formToObject(document.getElementById('tdhForm')));
    mountOverlay(v);
  }
});
btnUseForm.addEventListener('click', ()=>{
  const v = computeValues(formToObject(document.getElementById('tdhForm')));
  mountOverlay(v);
});
btnCopy.addEventListener('click', async ()=>{
  const json = JSON.stringify(layout, null, 2);
  try { await navigator.clipboard.writeText(json); alert('Layout copied. Paste it to me here in chat.'); }
  catch {
    const w = window.open('', '_blank', 'width=600,height=400');
    w.document.write('<pre style="white-space:pre-wrap;word-break:break-word;font:12px/1.3 monospace">'+
      json.replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))+'</pre>');
  }
});
btnSave.addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(layout,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tdh-layout.json'; a.click(); URL.revokeObjectURL(a.href);
});
btnReset.addEventListener('click', ()=>{
  localStorage.removeItem('tdh-layout-v3');
  alert('Layout cleared from this browser. Reloading defaults.');
  location.reload();
});
</script>

<script>
/* ---------- Example + JSON save ---------- */
const example = {
  name:"Carol Chinn", address:"1185 N 9th St", cityStateZip:"David City, NE 68632-1227",
  primaryContactName:"Nate Wegner", primaryPhone:"(402) 707-7187",
  insuranceCompany:"State Farm", claimNumber:"2788S499V",
  roofingLocations:["House"], tearOffLayers:"1", underlayment:"Synthetic",
  shinglesBrand:"CertainTeed", style:"Landmark", color:"Desert Tan",
  sqs:"", iceWater:"", dripEdge:"White", gutterApron:"White",
  vents:"9 Turtle Type; White", valleys:"Open; Painted", pipeJacks:"2 EA NC",
  roofPitch:"4/12", stories:"1", roofSize:"1,050 SF", roofType:["Gable"],
  ridgeCap:"", ridgeVent:"", sideWallFlashing:"82 LF White; Metal",
  guttersSize:"6", guttersColor:"White", downspoutsSize:"3x4", downspoutsColor:"Bronze",
  gutterGuards:["Leaf Free"], gutterNotes:"Gutter Guards are Leafguard Brand; 121 LF White",
  materialDrop:"Driveway", redeck:"", interiorDamage:"", cleanup:"Mag Roll Sweeper; Clean and haul debris",
  miscNotes:"Satellite needs detached and reset; R&R 1 EA 6\" Rain cap",
  agreedAmount:"ACV", firstPayment:"RCV + Approved Supplements", finalPayment:"RCV + Approved Supplements",
  sidingBrand:"", sidingStyle:"", sidingSqs:"", sidingColor:"",
  elevations:["Front","Right","Left","Rear"], trim:"", fascia:"Smooth", fasciaColor:"",
  soffit:"Vented", soffitColor:"", windowWraps:"Smooth", windowWrapsColor:"", blocks:["Light Blocks","Split Blocks"],
  custDate:"", custSignature:"", tdhDate:"", tdhSignature:"", instructions:"2513 River Rd Dr, Waterloo, NE 68069"
};

const form = document.getElementById('tdhForm');
document.getElementById('loadExample').addEventListener('click', ()=> fillForm(form, example));
document.getElementById('clearForm').addEventListener('click', ()=> form.reset());
document.getElementById('saveJson').addEventListener('click', ()=>{
  const data=formToObject(form);
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tdh-agreement.json'; a.click(); URL.revokeObjectURL(a.href);
});
</script>

<script>
/* ---------- Download: draw directly into a single-page PDF ---------- */
document.getElementById('downloadPdf').addEventListener('click', async ()=>{
  try {
    if (!(await ensureJsPDFLoaded())) return;
    const { jsPDF } = window.jspdf;
    const img = await loadTemplateImage(); // must exist

    const doc = new jsPDF({ unit:'in', format:'letter', compress:true });
    // background template full page
    doc.addImage(img, 'PNG', 0, 0, 8.5, 11);

    // text values
    const v = computeValues(formToObject(form));
    doc.setTextColor(0,0,0);
    doc.setFont('times','normal');
    doc.setFontSize(11);

    layout.forEach(item=>{
      const val = v[item.key] || '';
      if (!val) return; // skip empty
      const xIn = (item.x / PAGE_W) * 8.5;
      const yIn = (item.y / PAGE_H) * 11;
      if ((item.cls||'')==='check') {
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text('X', xIn, yIn);
        doc.setFont('times','normal'); doc.setFontSize(11);
        return;
      }
      if (item.w) {
        const wIn = (item.w / PAGE_W) * 8.5;
        const lines = doc.splitTextToSize(String(val), wIn);
        doc.text(lines, xIn, yIn);
      } else {
        doc.text(String(val), xIn, yIn);
      }
    });

    const filename = `TDH_Agreement_${(v.name||'Filled').replace(/\s+/g,'_')}.pdf`;
    doc.save(filename);
  } catch (err) {
    console.error(err);
    alert("Couldn’t generate the PDF.\n\nChecks:\n• Is assets/tdh-template.png uploaded?\n• Hard-refresh the page (Ctrl/Cmd+Shift+R).");
  }
});

/* ---------- Autosave ---------- */
const KEY='tdh-agreement-autosave';
try { const saved=JSON.parse(localStorage.getItem(KEY)||'null'); if (saved) fillForm(form, saved); } catch{}
form.addEventListener('input', ()=> localStorage.setItem(KEY, JSON.stringify(formToObject(form))));
</script>
</body>
</html>
